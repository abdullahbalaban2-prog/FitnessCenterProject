@model FitnessCenterProject.Models.Appointment
@using FitnessCenterProject.Models

@{
    ViewData["Title"] = "Randevu Al";
}

<h1 class="cf-title mb-4">RANDEVU AL</h1>

<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8 col-sm-12">

        <form asp-action="Create" method="post" class="cf-card p-4 shadow">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- HİZMET -->
            <div class="mb-3">
                <label class="cf-label">Hizmet</label>
                <select id="serviceSelect" asp-for="ServiceId" class="form-select cf-input">
                    <option value="">-- Hizmet Seçin --</option>
                    @foreach (var s in (IEnumerable<Service>)ViewBag.Services)
                    {
                        <option value="@s.Id"
                                data-price="@s.Price"
                                data-duration="@s.DurationMinutes">
                            @s.Name (@s.DurationMinutes dk - @s.Price ₺)
                        </option>
                    }
                </select>
                <span asp-validation-for="ServiceId" class="text-danger"></span>
            </div>

            <!-- EĞİTMEN -->
            <div class="mb-3">
                <label class="cf-label">Eğitmen</label>
                <select id="trainerSelect" asp-for="TrainerId" class="form-select cf-input" disabled>
                    <option value="">Önce hizmet seçin</option>
                </select>
                <span asp-validation-for="TrainerId" class="text-danger"></span>
            </div>

            <!-- TARİH -->
            <div class="mb-3">
                <label class="cf-label">Tarih</label>
                <input id="dateSelect" type="date" class="form-control cf-input" />
            </div>

            <!-- SLOT -->
            <h5 class="mt-4 mb-2 text-light">Uygun Saatler</h5>
            <div id="slotArea" class="cf-slot-container"></div>

            <div id="slotHint" class="text-warning small mt-2" style="display:none;">
                Lütfen bir saat seçin.
            </div>

            <!-- Hidden alanlar -->
            <input type="hidden" asp-for="StartDateTime" id="Appointment_StartDateTime" />
            <input type="hidden" asp-for="EndDateTime" id="Appointment_EndDateTime" />

            <!-- ÜCRET -->
            <div class="mb-3 mt-3">
                <label class="cf-label">Ücret</label>
                <input asp-for="Price" class="form-control cf-input" id="Appointment_Price" readonly />
            </div>

            <button type="submit" class="cf-btn-primary w-100 mt-3" id="submitBtn">
                Randevuyu Kaydet
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let duration = 0;
        let selectedSlot = null;

        const serviceSelect = document.getElementById("serviceSelect");
        const trainerSelect = document.getElementById("trainerSelect");
        const dateSelect = document.getElementById("dateSelect");
        const slotArea = document.getElementById("slotArea");

        const startHidden = document.getElementById("Appointment_StartDateTime");
        const endHidden = document.getElementById("Appointment_EndDateTime");
        const priceInput = document.getElementById("Appointment_Price");
        const slotHint = document.getElementById("slotHint");

        function clearSlots(messageHtml = "") {
            slotArea.innerHTML = messageHtml;
            selectedSlot = null;
            startHidden.value = "";
            endHidden.value = "";
        }

        function getSelectedServiceOption() {
            const opt = serviceSelect.options[serviceSelect.selectedIndex];
            return opt && opt.value ? opt : null;
        }

        // 1) Hizmet seçilince eğitmenleri getir + fiyat/süre ayarla
        serviceSelect.addEventListener("change", async () => {
            clearSlots();

            const opt = getSelectedServiceOption();
            if (!opt) {
                trainerSelect.innerHTML = "<option value=''>Önce hizmet seçin</option>";
                trainerSelect.disabled = true;
                priceInput.value = "";
                duration = 0;
                return;
            }

            duration = parseInt(opt.dataset.duration || "0");
            priceInput.value = opt.dataset.price || "";

            const serviceId = serviceSelect.value;

            const res = await fetch(`/api/trainers/by-service/${serviceId}`);
            const list = await res.json();

            trainerSelect.innerHTML = "<option value=''>Eğitmen Seç</option>";
            list.forEach(t => {
                trainerSelect.innerHTML += `<option value="${t.id}">${t.fullName}</option>`;
            });

            trainerSelect.disabled = false;

            // Eğer kullanıcı önceden tarih seçtiyse slotları da yenile
            await loadSlots();
        });

        trainerSelect.addEventListener("change", loadSlots);
        dateSelect.addEventListener("change", loadSlots);

        // 2) Slotları yükle (API: free-slots)
        async function loadSlots() {
            slotHint.style.display = "none";
            clearSlots();

            const trainerId = trainerSelect.value;
            const serviceId = serviceSelect.value;
            const date = dateSelect.value; // yyyy-MM-dd

            if (!trainerId || !serviceId || !date) return;

            // duration göndermeye gerek yok -> API serviceId ile süreyi buluyor
            const url = `/api/trainers/free-slots?trainerId=${trainerId}&date=${date}&serviceId=${serviceId}`;
            const res = await fetch(url);

            if (!res.ok) {
                clearSlots(`<div class="alert alert-danger mt-2">Slotlar alınamadı.</div>`);
                return;
            }

            const slots = await res.json();

            if (!slots || slots.length === 0) {
                clearSlots(`<div class="alert alert-warning mt-2">Bu tarihte uygun randevu yok.</div>`);
                return;
            }

            // Slot butonlarını çiz
            slotArea.innerHTML = "";
            slots.forEach(slot => {
                const hour = slot.substring(11, 16);

                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "cf-slot-btn";
                btn.textContent = hour;
                btn.onclick = () => selectSlot(slot, btn);

                slotArea.appendChild(btn);
            });
        }

        // 3) Slot seç
        function selectSlot(slot, btnEl) {
            // aktif buton görünümü
            document.querySelectorAll(".cf-slot-btn").forEach(b => b.classList.remove("active"));
            btnEl.classList.add("active");

            selectedSlot = slot;

            // ÖNEMLİ: toISOString() KULLANMA -> 3 saat kaydırır.
            // API slotu "2025-12-27T08:00" döndürüyor, bunu aynen gönderiyoruz.
            startHidden.value = slot;

            const start = new Date(slot);
            const end = new Date(start.getTime() + (duration * 60000));
            // yine ISO yapmadan, local string formatı:
            const pad = n => String(n).padStart(2, "0");
            const endStr = `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}T${pad(end.getHours())}:${pad(end.getMinutes())}`;
            endHidden.value = endStr;
        }

        // 4) Form submit: saat seçilmediyse engelle
        document.getElementById("submitBtn").addEventListener("click", (e) => {
            if (!startHidden.value) {
                e.preventDefault();
                slotHint.style.display = "block";
            }
        });
    </script>
}

<style>
    /* Crossfit / Red-Black */
    .cf-title {
        color: #ff3b30;
        font-weight: 800;
        text-align: center;
        letter-spacing: 2px;
    }

    .cf-card {
        background: #0f0f0f;
        border: 2px solid rgba(255,59,48,.55);
        border-radius: 14px;
    }

    .cf-label {
        color: #ff6b61;
        font-weight: 700;
    }

    .cf-input {
        background: #161616;
        color: #fff;
        border: 1px solid rgba(255,59,48,.55);
    }

        .cf-input:focus {
            background: #111;
            color: #fff;
            border-color: #ff3b30;
            box-shadow: 0 0 0 .2rem rgba(255,59,48,.15);
        }

    .cf-btn-primary {
        background: #ff3b30;
        border: none;
        padding: 12px;
        font-weight: 800;
        border-radius: 10px;
    }

        .cf-btn-primary:hover {
            filter: brightness(1.05);
        }

    .cf-slot-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
    }

    .cf-slot-btn {
        background: #1b1b1b;
        color: #fff;
        border: 1px solid rgba(255,59,48,.55);
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        transition: .15s;
    }

        .cf-slot-btn:hover {
            transform: translateY(-1px);
            border-color: #ff3b30;
        }

        .cf-slot-btn.active {
            background: #ff3b30;
            border-color: #ff3b30;
            color: #0b0b0b;
        }
</style>