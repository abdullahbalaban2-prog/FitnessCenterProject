@using FitnessCenterProject.Models
@model FitnessCenterProject.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
    var services = ViewBag.Services as IEnumerable<Service> ?? Enumerable.Empty<Service>();
}

<h2 class="mb-4">Randevu Al</h2>

<div class="row">
    <div class="col-md-6">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- HİZMET -->
            <div class="mb-3">
                <label asp-for="ServiceId" class="form-label"></label>
                <select asp-for="ServiceId" class="form-select" id="serviceSelect">
                    <option value="">-- Hizmet Seçin --</option>
                    @foreach (var s in services)
                    {
                        <option value="@s.Id"
                                data-price="@s.Price.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                data-duration="@s.DurationMinutes">
                            @s.Name (@s.DurationMinutes dk, @s.Price.ToString("0.00") ₺)
                        </option>
                    }
                </select>
                <span asp-validation-for="ServiceId" class="text-danger"></span>
            </div>

            <!-- EĞİTMEN -->
            <div class="mb-3">
                <label asp-for="TrainerId" class="form-label"></label>
                <select asp-for="TrainerId" class="form-select" id="trainerSelect" asp-items="ViewBag.Trainers">
                    <option value="">Önce bir hizmet seçin</option>
                </select>
                <span asp-validation-for="TrainerId" class="text-danger"></span>
            </div>

            <!-- BAŞLANGIÇ -->
            <div class="mb-3">
                <label asp-for="StartDateTime" class="form-label"></label>
                <input asp-for="StartDateTime" class="form-control" type="datetime-local" />
                <span asp-validation-for="StartDateTime" class="text-danger"></span>
            </div>

            <!-- ÜCRET -->
            <div class="mb-3">
                <label asp-for="Price" class="form-label"></label>
                <input asp-for="Price" class="form-control" readonly />
            </div>

            <button type="submit" class="btn btn-primary">Kaydet</button>
            <a asp-action="MyAppointments" class="btn btn-secondary ms-2">Randevularım</a>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const serviceSelect = document.getElementById('serviceSelect');
            const trainerSelect = document.getElementById('trainerSelect');
            const priceInput = document.getElementById('Price');

            async function loadTrainers(serviceId, selectedTrainerId) {
                trainerSelect.innerHTML = "";

                if (!serviceId) {
                    const opt = document.createElement('option');
                    opt.value = "";
                    opt.textContent = "Önce bir hizmet seçin";
                    trainerSelect.appendChild(opt);
                    return;
                }

                try {
                    const response = await fetch(`/api/trainers/by-service/${serviceId}`);
                    if (!response.ok) throw new Error("Eğitmen listesi alınamadı.");

                    const data = await response.json();

                    const placeholder = document.createElement('option');
                    placeholder.value = "";
                    placeholder.textContent = "Eğitmen seçin";
                    trainerSelect.appendChild(placeholder);

                    if (!data || data.length === 0) {
                        const opt = document.createElement('option');
                        opt.value = "";
                        opt.textContent = "Bu hizmet için tanımlı eğitmen yok";
                        trainerSelect.appendChild(opt);
                        return;
                    }

                    for (const t of data) {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = `${t.fullName} (${t.specialty ?? "Genel"})`;

                        if (selectedTrainerId && Number(selectedTrainerId) === Number(t.id)) {
                            opt.selected = true;
                        }
                        trainerSelect.appendChild(opt);
                    }
                } catch (err) {
                    console.error(err);
                    const opt = document.createElement('option');
                    opt.value = "";
                    opt.textContent = "Eğitmenler yüklenirken hata oluştu";
                    trainerSelect.appendChild(opt);
                }
            }

            serviceSelect.addEventListener('change', function () {
                const selected = this.options[this.selectedIndex];
                const serviceId = this.value;

                if (selected && selected.dataset.price && priceInput) {
                    // Kullanıcıya TR formatında gösterelim (virgül)
                    priceInput.value = selected.dataset.price.replace('.', ',');
                } else if (priceInput) {
                    priceInput.value = "";
                }

                loadTrainers(serviceId, null);
            });

            // Post-back sonrası seçimleri koru
            const initialServiceId = '@Model.ServiceId';
            const initialTrainerId = '@Model.TrainerId';

            if (initialServiceId && initialServiceId !== '0') {
                serviceSelect.value = initialServiceId;

                const selected = serviceSelect.options[serviceSelect.selectedIndex];
                if (selected && selected.dataset.price && priceInput) {
                    priceInput.value = selected.dataset.price.replace('.', ',');
                }

                loadTrainers(initialServiceId, initialTrainerId);
            }
        })();
    </script>
}
