@model FitnessCenterProject.Models.Appointment
@using FitnessCenterProject.Models

@{
    ViewData["Title"] = "Randevu Al";
}

<h1 class="cf-title mb-4">Randevu Al</h1>

<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <form asp-action="CreateFromSlot" method="post" class="cf-card p-4 shadow">
            @Html.AntiForgeryToken()

            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- Hizmet -->
            <div class="mb-3">
                <label class="cf-label">Hizmet</label>
                <select id="serviceSelect" name="serviceId" class="cf-input">
                    <option value="">-- Hizmet Seçin --</option>
                    @foreach (var s in (IEnumerable<Service>)ViewBag.Services)
                    {
                        <option value="@s.Id"
                                data-price="@s.Price"
                                data-duration="@s.DurationMinutes">
                            @s.Name (@s.DurationMinutes dk - @s.Price ₺)
                        </option>
                    }
                </select>
            </div>

            <!-- Eğitmen -->
            <div class="mb-3">
                <label class="cf-label">Eğitmen</label>
                <select id="trainerSelect" name="trainerId" class="cf-input">
                    <option value="">Önce hizmet seçin</option>
                </select>
            </div>

            <!-- Tarih -->
            <div class="mb-3">
                <label class="cf-label">Tarih</label>
                <input id="dateSelect" type="date" class="cf-input" />
            </div>

            <!-- Slotlar -->
            <h5 class="mt-3 mb-2">Uygun Saatler</h5>
            <div id="slotArea" class="cf-slot-container"></div>

            <!-- Seçili başlangıç -->
            <input type="hidden" id="slotStart" name="start" />

            <!-- Ücret bilgisi -->
            <div class="mt-3">
                <label class="cf-label">Ücret</label>
                <input id="priceBox" class="cf-input" readonly />
            </div>

            <button class="cf-btn-primary w-100 mt-3">Randevuyu Kaydet</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let duration = 0;

        const serviceSelect = document.getElementById("serviceSelect");
        const trainerSelect = document.getElementById("trainerSelect");
        const dateSelect = document.getElementById("dateSelect");
        const slotArea = document.getElementById("slotArea");
        const priceBox = document.getElementById("priceBox");
        const slotStart = document.getElementById("slotStart");

        serviceSelect.addEventListener("change", async () => {
            const id = serviceSelect.value;
            if (!id) { trainerSelect.innerHTML = "<option value=''>Önce hizmet seçin</option>"; return; }

            duration = parseInt(serviceSelect.options[serviceSelect.selectedIndex].dataset.duration);
            priceBox.value = serviceSelect.options[serviceSelect.selectedIndex].dataset.price;

            const res = await fetch(`/api/trainers/by-service/${id}`);
            const list = await res.json();

            trainerSelect.innerHTML = "<option value=''>Eğitmen Seç</option>";
            list.forEach(t => {
                trainerSelect.innerHTML += `<option value="${t.id}">${t.fullName}</option>`;
            });

            loadSlots();
        });

        dateSelect.addEventListener("change", loadSlots);
        trainerSelect.addEventListener("change", loadSlots);

        async function loadSlots() {
            slotArea.innerHTML = "";
            slotStart.value = "";

            const trainerId = trainerSelect.value;
            const serviceId = serviceSelect.value;
            const date = dateSelect.value; // yyyy-MM-dd

            if (!trainerId || !serviceId || !date) return;

            // duration'ı göndermesek bile serviceId ile sunucu buluyor.
            const res = await fetch(`/api/trainers/free-slots?trainerId=${trainerId}&date=${date}&serviceId=${serviceId}&duration=${duration}`);
            const slots = await res.json();

            if (!Array.isArray(slots) || slots.length === 0) {
                slotArea.innerHTML = `<div class='alert alert-warning'>Bu tarihte uygun randevu yok.</div>`;
                return;
            }

            slots.forEach(s => {
                const hour = s.substring(11,16);
                slotArea.innerHTML += `<button type="button" class="cf-slot-btn" data-val="${s}">${hour}</button>`;
            });

            // Buton tıklama
            [...slotArea.querySelectorAll(".cf-slot-btn")].forEach(btn => {
                btn.addEventListener("click", () => {
                    [...slotArea.querySelectorAll(".cf-slot-btn")].forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    // Sunucu yerel string bekliyor (Z yok)
                    slotStart.value = btn.dataset.val;
                });
            });
        }
    </script>
}

<style>
    /* CrossFit kırmızı-siyah tema */
    .cf-title {
        color: #d90000;
        font-weight: 800;
        text-transform: uppercase;
        text-align: center;
        letter-spacing: .5px
    }

    .cf-card {
        background: #0f0f10;
        color: #fff;
        border-radius: 12px;
        border: 2px solid #d90000
    }

    .cf-label {
        color: #ff4a4a;
        font-weight: 700
    }

    .cf-input {
        background: #1a1a1a;
        color: #fff;
        border: 1px solid #d90000;
        border-radius: 8px;
        padding: .6rem .8rem
    }

        .cf-input:focus {
            outline: none;
            border-color: #ff2a2a;
            box-shadow: 0 0 0 3px rgba(255,42,42,.2)
        }

    .cf-btn-primary {
        background: #d90000;
        border: none;
        padding: .8rem 1rem;
        font-weight: 800;
        border-radius: 10px
    }

        .cf-btn-primary:hover {
            background: #ff1a1a
        }

    .cf-slot-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px
    }

    .cf-slot-btn {
        background: #10d410;
        color: #000;
        border: none;
        padding: .6rem 1rem;
        border-radius: 8px;
        font-weight: 800;
        cursor: pointer;
        transition: .15s
    }

        .cf-slot-btn:hover {
            transform: translateY(-1px)
        }

        .cf-slot-btn.active {
            outline: 3px solid #fff;
            box-shadow: 0 0 0 3px rgba(255,42,42,.35) inset
        }
</style>
